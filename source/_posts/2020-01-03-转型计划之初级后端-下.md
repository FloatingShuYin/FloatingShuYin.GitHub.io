---
layout: w
title: 转型计划之初级后端(下)
date: 2020-01-03 18:47:38
tags:
- 转型计划
- 初级后端
---

[nest-cli docs]: https://docs.nestjs.com/cli/overview
[转型计划之初级后端(上)]: https://floatsyi.com/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/
[转型计划之初级后端(中)]: https://floatsyi.com/2019/12/31/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%AD/
[nest-cli]: https://github.com/nestjs/nest-cli
[yarn-upgrade-all]: https://github.com/tylerlong/yarn-upgrade-all
[yarn]: https://github.com/yarnpkg/yarn
[config]: https://github.com/lorenwest/node-config
[dotenv]: https://github.com/motdotla/dotenv
[prettier]: https://github.com/prettier/prettier
[prettier-vscode]: https://github.com/prettier/prettier-vscode
[vscode]: https://github.com/microsoft/vscode
[npm]: https://github.com/npm/npm
[jest]: https://github.com/facebook/jest
[nest-winston]: https://github.com/gremo/nest-winston
[使用 Git-crypt 加密生产配置文件]: https://github.com/lorenwest/node-config/wiki/Securing-Production-Config-Files


## 参考
- [nest-cli docs][]
- [转型计划之初级后端(上)][]
- [转型计划之初级后端(中)][]
- [使用 Git-crypt 加密生产配置文件][]

## 资源
- [nest-cli][]
- [yarn-upgrade-all][]
- [yarn][]
- [npm][]
- [config][]
- [dotenv][]
- [prettier][]
- [prettier-vscode][]
- [vscode][]
- [jest][]
- [nest-winston][]

## 前言
> 当前置知识储备相对完整，所有的东西都是不言而喻的

此文是对 [转型计划之初级后端(中)][] 的整理与补充, 措辞尽量精简以方便后续查阅。

## 前置知识
- [nest-cli docs][]
- [转型计划之初级后端(上)][]
- [转型计划之初级后端(中)][]

## 初始化项目
使用 [npm][] 全局安装一些命令行工具
```powershell
npm install -g @nestjs/cli
npm install -g yarn
npm install -g yarn-upgrade-all
```

使用 [nest-cli][] 初始化项目， 包管理器选 [yarn][]
```powershell
nest new desktop-deployment-management-tool-api
cd desktop-deployment-management-tool-api
```

使用 [yarn-upgrade-all][] 更新依赖
```powershell
yarn-upgrade-all
```

修改 [prettier][] 配置文件 .prettierrc
```json
{
  "singleQuote": true,
  "trailingComma": "all",
  "semi": false
}
```

创建编辑器工作区配置
```powershell
mkdir .vscode;touch .vscode/setting.json
```

配置 [prettier][] 的 [vscode][] 插件: [prettier-vscode][]

setting.json
```json
{
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.formatOnSave": true
  },
}
```

使用 [nest-cli][] 生成 Interceptors, Exception filters, Pipes, Guards
```powershell
nest generate interceptor common/interceptors/logging
nest generate filter common/filters/all-exception
nest generate pipe common/pipes/body-validation
nest generate guard common/guard/auth
```

运行 [jest][] 测试
```powershell
yarn test
```

## 配置
使用 [yarn][] 添加运行时依赖 [config][] 和 [dotenv][]
```powershell
yarn add config dotenv
```

创建并编辑 [config][] 配置文件
```powershell
mkdir config
touch config/default.json
touch config/custom-environment-variables.json
touch src/config.ts
touch .env
```

default.json
```json
{
  "env": "development",
  "port": 3000
}
```

custom-environment-variables.json
```json
{
  "env": "NODE_ENV",
  "port": "PORT"
}
```

config.ts
```ts
import * as dotenv from "dotenv"
dotenv.config()

export interface Config {
  env: string
  port: number
}

export const config: Config = require('config')
```

.env
```
NODE_ENV=dev
PORT=3000
```

.env 中的值映射到 custom-environment-variables.json 对应的值上，
而 custom-environment-variables.json 中的值映射到 default.json 对应的值上.
最终 .env 中的值覆盖 default.json 对应的值.

加密敏感信息请参考: [使用 Git-crypt 加密生产配置文件][]

## 日志
使用 [yarn][] 添加运行时依赖 [nest-winston][]
```powershell
yarn add nest-winston
```

logging.interceptor.ts
```ts
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
  LoggerService,
} from '@nestjs/common'
import { Observable } from 'rxjs'
import { tap } from 'rxjs/operators'
import { Request, Response } from 'express'

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  constructor(private readonly logger: LoggerService) {}

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const ctx = context.switchToHttp()
    const response = ctx.getResponse<Response>()
    const request = ctx.getRequest<Request>()
    const method = request.method
    const url = request.url

    const requestTime = Date.now()

    // Add request time to params to be used in exception filters
    request.params.requestTime = requestTime

    return next
      .handle()
      .pipe(
        tap(() =>
          this.logger.log(
            `${method} ${url} - ${response.statusCode} - ${Date.now() -
              requestTime}ms`,
          ),
        ),
      )
  }
}
```

main.ts
```ts
```


