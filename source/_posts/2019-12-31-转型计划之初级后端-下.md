---
title: 转型计划之初级后端(下)
date: 2019-12-31 08:58:37
tags:
- 初级后端
- 转型计划
---

[Securely build, share and run any application, anywhere: docker]: https://floatsyi.com/2019/12/29/Securely-build-share-and-run-any-application-anywhere-docker/
[typescript]: https://github.com/microsoft/TypeScript
[nestjs]: https://github.com/nestjs/nest
[typeorm]: https://github.com/typeorm/typeorm
[mysql]: https://github.com/mysqljs/mysql
[docker]: https://github.com/topics/docker
[转型计划之初级后端(上)]: https://floatsyi.com/2019/12/30/%E8%BD%AC%E5%9E%8B%E8%AE%A1%E5%88%92%E4%B9%8B%E5%88%9D%E7%BA%A7%E5%90%8E%E7%AB%AF-%E4%B8%8A/
[有类型的 javascript : typescript]: https://floatsyi.com/2019/10/07/%E6%9C%89%E7%B1%BB%E5%9E%8B%E7%9A%84-javascript-typescript/
[mysql 学习笔记]: https://floatsyi.com/2019/10/12/mysql-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/
[nestjs-realworld-example-app]: https://github.com/lujakob/nestjs-realworld-example-app
[docs.nestjs.com]: https://docs.nestjs.com/
[精读 《Nestjs 文档》]: https://zhuanlan.zhihu.com/p/28621374
[yeoman]: https://yeoman.io/
[hub.docker.com: mysql]: https://hub.docker.com/_/mysql

## 参考
- [转型计划之初级后端(上)][]
- [Securely build, share and run any application, anywhere: docker][]
- [有类型的 javascript : typescript][]
- [docs.nestjs.com][]
- [精读 《Nestjs 文档》][]

## 资源
- [typescript][]
- [nestjs][]
- [typeorm][]
- [mysql][]
- [docker][]
- [nestjs-realworld-example-app][]
- [yeoman][]
- [hub.docker.com: mysql][]

## 前言
[转型计划之初级后端(上)][] 是解剖分析部分， 这篇是重构部分，利用完整的重构来检验自己是否已经达到融会贯通的程度。

## 前置知识
- [转型计划之初级后端(上)][]
- [Securely build, share and run any application, anywhere: docker][]
- [有类型的 javascript : typescript][]
- [docs.nestjs.com][]

## Refactor

1. 第一步当然是要找一个好的 Boilerplate， 一般情况下是在 [yeoman][] 这个网站找
这里我在了解学习 nestjs 的过程中在 github 上发现了一个很不错的 Boilerplate: [nestjs-realworld-example-app][], 所以就决定是它了。

2. 先把 [nestjs-realworld-example-app][] `git clone https://github.com/lujakob/nestjs-realworld-example-app.git` 到本地
然后读 README.md 文档，查看开发环境是否符合要求，然后按照 README.md 文档的提示将这个 Boilerplate 运行起来, 确保没有错误发生。

3. 按照  README.md 文档的要求， 需要安装 mysql 数据库，这里我一开始是决定使用 WSL 来做这件事情， 但不久前，我看完了 docker 的文档，所以决定使用 docker 来做这件事情， 这样更符合现代的开发部署流程。
docker 的安装与使用请参考: [Securely build, share and run any application, anywhere: docker][]
在项目根目录 `mkdir mysql` `touch docker-compose.yml`
docker-compose.yml:
```yml
version: '3.1'

services:

  db:
    image: mysql
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: nestjsrealworld
    ports:
      - "3306:3306"
    volumes:
      - ./mysql:/var/lib/mysql

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
```
docker-compose.yml 配置文件的编写请参考: [hub.docker.com: mysql][]
然后按照 README.md 要求 `cp ormconfig.json.example ormconfig.json`
然后修改 ormconfig.json 内容如下:
```json
{
  "type": "mysql",
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "rootpassword",
  "database": "nestjsrealworld",
  "entities": ["src/**/**.entity{.ts,.js}"],
  "synchronize": true
}
```
4. 现在 README.md 要求的开发环境已经准备好了， 只需查看 package.json 的 script 字段
在这里加入了 `"db": "docker-compose up -d"` 一行
package.json:
```json
{
  "scripts": {
    "start": "node index.js",
    "start:watch": "nodemon",
    "prestart:prod": "tsc",
    "start:prod": "node dist/main.js",
    "test": "jest --config=jest.config.json --forceExit",
    "test:watch": "jest --watch --config=jest.config.json",
    "test:coverage": "jest --config=jest.config.json --coverage --coverageDirectory=coverage",
    "db": "docker-compose up -d"
  },
}
```
现在先后执行 `npm run db` `npm run start`  项目就运行起来了。
默认情况下 docker 是开机自启动的， 这样子就算你重启计算机 docker 也会自动运行你设置的 `restart: always` 容器
因此 `npm run db` 只需要首次执行时， 执行一次即可.

5.
然后 先吃饭...
`TODO`


